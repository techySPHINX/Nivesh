// Nivesh - Prisma Schema
// PostgreSQL Database Schema for Financial Data

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==========================================
// User Management
// ==========================================
model User {
  id                String      @id @default(uuid())
  email             String      @unique
  phoneNumber       String?     @unique
  firstName         String
  lastName          String
  dateOfBirth       DateTime?
  profilePicture    String?
  kycStatus         String      @default("pending") // pending, verified, rejected
  riskProfile       String?     // conservative, moderate, aggressive
  firebaseUid       String?     @unique
  
  // Relationships
  accounts          Account[]
  transactions      Transaction[]
  investments       Investment[]
  goals             Goal[]
  alerts            Alert[]
  
  // Metadata
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  lastLoginAt       DateTime?
  isActive          Boolean     @default(true)
  
  @@map("users")
  @@index([email])
  @@index([firebaseUid])
}

// ==========================================
// Financial Accounts
// ==========================================
model Account {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Account details
  accountName       String
  accountNumber     String      @unique
  accountType       String      // savings, current, credit_card, investment, loan
  bankName          String
  ifscCode          String?
  
  // Balance tracking
  balance           Decimal     @db.Decimal(15, 2)
  currency          String      @default("INR")
  
  // Status
  status            String      @default("ACTIVE") // ACTIVE, INACTIVE, FROZEN, CLOSED
  
  // External integration
  isLinked          Boolean     @default(false)
  lastSyncedAt      DateTime?
  
  // Relationships
  transactions      Transaction[]
  
  // Metadata
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("accounts")
  @@index([userId])
  @@index([accountType])
  @@index([status])
}

// ==========================================
// Transactions
// ==========================================
model Transaction {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  accountId         String
  account           Account     @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Transaction details
  amount            Decimal     @db.Decimal(15, 2)
  currency          String      @default("INR")
  type              String      // DEBIT, CREDIT
  category          String      // FOOD, TRANSPORT, SALARY, etc.
  description       String
  merchantName      String?
  
  // Date information
  transactionDate   DateTime
  
  // Reference
  referenceNumber   String?
  
  // Status
  status            String      @default("PENDING") // PENDING, COMPLETED, FAILED, REVERSED
  
  // Metadata
  metadata          Json?
  
  // Timestamps
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("transactions")
  @@index([userId, transactionDate])
  @@index([accountId])
  @@index([category])
  @@index([status])
}

// ==========================================
// Investments
// ==========================================
model Investment {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Investment details
  investmentType    String      // mutual_fund, stock, bond, gold, crypto, fd, etc.
  assetName         String
  isinCode          String?
  folioNumber       String?
  
  // Holding details
  units             Decimal?    @db.Decimal(15, 4)
  averageBuyPrice   Decimal     @db.Decimal(15, 2)
  currentPrice      Decimal     @db.Decimal(15, 2)
  currentValue      Decimal     @db.Decimal(15, 2)
  investedAmount    Decimal     @db.Decimal(15, 2)
  
  // Returns
  absoluteReturn    Decimal?    @db.Decimal(15, 2)
  xirr              Decimal?    @db.Decimal(5, 2)
  
  // Date information
  purchaseDate      DateTime
  lastUpdatedPrice  DateTime?
  
  // Metadata
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("investments")
  @@index([userId])
  @@index([investmentType])
}

// ==========================================
// Goals
// ==========================================
model Goal {
  id                    String            @id @default(uuid())
  userId                String
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Goal details
  name                  String
  title                 String?           // Optional display title
  description           String
  category              String            // SAVINGS, INVESTMENT, DEBT_PAYMENT, EMERGENCY_FUND, RETIREMENT, EDUCATION, VACATION, REAL_ESTATE, VEHICLE, WEDDING, BUSINESS, OTHER
  goalType              String?           // Optional goal type classification
  
  // Amounts
  targetAmount          Decimal           @db.Decimal(15, 2)
  currentAmount         Decimal           @default(0) @db.Decimal(15, 2)
  currency              String            @default("INR")
  
  // Timeline
  startDate             DateTime
  targetDate            DateTime
  
  // Status
  status                String            @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED, CANCELLED, EXPIRED
  priority              Int               @default(2) // 1=LOW, 2=MEDIUM, 3=HIGH, 4=CRITICAL
  
  // Auto-contribution settings
  linkedAccountId       String?
  autoContribute        Boolean           @default(false)
  contributionAmount    Decimal?          @db.Decimal(15, 2)
  contributionFrequency String?           // DAILY, WEEKLY, MONTHLY
  
  // Relationships
  contributions         GoalContribution[]
  milestones            Milestone[]
  
  // Metadata
  metadata              Json?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  
  @@map("goals")
  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([targetDate])
}

// ==========================================
// Goal Contributions
// ==========================================
model GoalContribution {
  id                String      @id @default(uuid())
  goalId            String
  goal              Goal        @relation(fields: [goalId], references: [id], onDelete: Cascade)
  userId            String
  
  // Contribution details
  amount            Decimal     @db.Decimal(15, 2)
  currency          String      @default("INR")
  type              String      @default("MANUAL") // MANUAL, AUTOMATIC, TRANSFER, ADJUSTMENT
  
  // References
  transactionId     String?
  accountId         String?
  notes             String?
  
  // Metadata
  metadata          Json?
  createdAt         DateTime    @default(now())
  
  @@map("goal_contributions")
  @@index([goalId])
  @@index([userId])
  @@index([createdAt])
}

// ==========================================
// Goal Milestones
// ==========================================
model Milestone {
  id                String      @id @default(uuid())
  goalId            String
  goal              Goal        @relation(fields: [goalId], references: [id], onDelete: Cascade)
  
  // Milestone details
  title             String
  targetAmount      Decimal     @db.Decimal(15, 2)
  targetDate        DateTime
  isCompleted       Boolean     @default(false)
  completedAt       DateTime?
  
  // Metadata
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("milestones")
  @@index([goalId])
}

// ==========================================
// Alerts
// ==========================================
model Alert {
  id                String      @id @default(uuid())
  userId            String
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Alert details
  alertType         String      // overspending, goal_at_risk, investment_alert, anomaly, recommendation
  severity          String      // info, warning, critical
  title             String
  message           String
  actionable        Boolean     @default(false)
  actionUrl         String?
  
  // Status
  isRead            Boolean     @default(false)
  readAt            DateTime?
  isDismissed       Boolean     @default(false)
  dismissedAt       DateTime?
  
  // Metadata
  metadata          Json?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  @@map("alerts")
  @@index([userId, createdAt])
  @@index([isRead, isDismissed])
}

// ==========================================
// Prompt Registry (LLM Integration)
// ==========================================
model PromptRegistry {
  id                    String                @id @default(uuid())
  promptName            String
  version               String
  promptText            String                @db.Text
  systemInstruction     String?               @db.Text
  
  // Generation config
  temperature           Float                 @default(0.3)
  topP                  Float                 @default(0.9)
  topK                  Int                   @default(40)
  maxTokens             Int                   @default(2048)
  model                 String                @default("gemini-1.5-pro")
  
  // Status management
  status                String                @default("draft") // draft, testing, canary, production, deprecated
  rolloutPercentage     Int                   @default(0)
  
  // Metadata
  createdBy             String?
  createdAt             DateTime              @default(now())
  deployedAt            DateTime?
  deprecatedAt          DateTime?
  performanceMetrics    Json?
  rollbackTrigger       String?
  
  // Relationships
  executions            PromptExecution[]
  controlTests          PromptABTest[]        @relation("ControlPrompt")
  treatmentTests        PromptABTest[]        @relation("TreatmentPrompt")
  
  @@unique([promptName, version])
  @@map("prompt_registry")
  @@index([promptName, status])
  @@index([status, rolloutPercentage])
}

model PromptABTest {
  id                    String                @id @default(uuid())
  testName              String
  controlPromptId       String
  controlPrompt         PromptRegistry        @relation("ControlPrompt", fields: [controlPromptId], references: [id], onDelete: Cascade)
  treatmentPromptId     String
  treatmentPrompt       PromptRegistry        @relation("TreatmentPrompt", fields: [treatmentPromptId], references: [id], onDelete: Cascade)
  
  // Test configuration
  trafficSplitPercentage Int                  @default(50) // % going to treatment
  
  // Status
  status                String                @default("running") // running, paused, completed
  startDate             DateTime              @default(now())
  endDate               DateTime?
  
  // Results
  metrics               Json?
  winner                String?               // 'control', 'treatment', or null
  
  @@map("prompt_ab_tests")
  @@index([testName])
  @@index([status, startDate])
}

model PromptExecution {
  id                    String                @id @default(uuid())
  promptId              String
  prompt                PromptRegistry        @relation(fields: [promptId], references: [id], onDelete: Cascade)
  userId                String
  
  // Execution details
  inputText             String                @db.Text
  outputText            String?               @db.Text
  tokensUsed            Int?
  latencyMs             Int?
  confidenceScore       Float?
  
  // Feedback & Safety
  userFeedback          Int?                  @default(0) // -1 (thumbs down), 0 (no feedback), 1 (thumbs up)
  safetyTriggered       Boolean               @default(false)
  safetyReason          String?
  
  // Context
  ragContextUsed        Json?
  functionCallsExecuted Json?
  
  // Metadata
  traceId               String?
  createdAt             DateTime              @default(now())
  
  @@map("prompt_executions")
  @@index([promptId, createdAt])
  @@index([userId, createdAt])
  @@index([traceId])
}

