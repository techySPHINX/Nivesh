version: "3.9"

# Nivesh - Complete Docker Infrastructure
# All services required for Issues #1-4 implementation

services:
  # ==========================================
  # Database Services
  # ==========================================

  postgres:
    image: postgres:16-alpine
    container_name: nivesh-postgres
    environment:
      POSTGRES_USER: nivesh_user
      POSTGRES_PASSWORD: nivesh_password
      POSTGRES_DB: nivesh_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U nivesh_user"]
      interval: 10s
      timeout: 5s
      retries: 5

  neo4j:
    image: neo4j:5.15-community
    container_name: nivesh-neo4j
    environment:
      NEO4J_AUTH: neo4j/nivesh_password
      NEO4J_dbms_memory_pagecache_size: 1G
      NEO4J_dbms_memory_heap_initial__size: 1G
      NEO4J_dbms_memory_heap_max__size: 2G
    ports:
      - "7474:7474" # HTTP
      - "7687:7687" # Bolt
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
    networks:
      - nivesh-network
    healthcheck:
      test:
        [
          "CMD",
          "cypher-shell",
          "-u",
          "neo4j",
          "-p",
          "nivesh_password",
          "RETURN 1",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  mongodb:
    image: mongo:7.0
    container_name: nivesh-mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME: nivesh_user
      MONGO_INITDB_ROOT_PASSWORD: nivesh_password
      MONGO_INITDB_DATABASE: nivesh_conversations
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: nivesh-redis
    command: redis-server --requirepass nivesh_password --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  clickhouse:
    image: clickhouse/clickhouse-server:23.12-alpine
    container_name: nivesh-clickhouse
    environment:
      CLICKHOUSE_USER: nivesh_user
      CLICKHOUSE_PASSWORD: nivesh_password
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
    ports:
      - "8123:8123" # HTTP
      - "9000:9000" # Native
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "localhost:8123/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Message Queue (Kafka)
  # ==========================================

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: nivesh-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - nivesh-network

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: nivesh-kafka
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    ports:
      - "29092:29092"
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - nivesh-network
    healthcheck:
      test:
        [
          "CMD",
          "kafka-broker-api-versions",
          "--bootstrap-server",
          "localhost:9092",
        ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Vector Database (Qdrant) - Issue #1
  # ==========================================

  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: nivesh-qdrant
    environment:
      QDRANT__SERVICE__GRPC_PORT: 6334
      QDRANT__SERVICE__HTTP_PORT: 6333
    ports:
      - "6333:6333" # REST API
      - "6334:6334" # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:6333/"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # MLOps Infrastructure - Issue #4
  # ==========================================

  mlflow:
    image: ghcr.io/mlflow/mlflow:v2.10.0
    container_name: nivesh-mlflow
    command: mlflow server --host 0.0.0.0 --port 5000 --backend-store-uri sqlite:///mlflow.db --default-artifact-root /mlflow/artifacts
    ports:
      - "5000:5000"
    volumes:
      - mlflow_data:/mlflow
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ML Model Server (FastAPI) - Issue #4
  ml-api:
    build:
      context: ./ml-services
      dockerfile: Dockerfile
    container_name: nivesh-ml-api
    environment:
      MLFLOW_TRACKING_URI: http://mlflow:5000
      REDIS_URL: redis://:nivesh_password@redis:6379/0
      MODEL_CACHE_TTL: 3600
    ports:
      - "8000:8000"
    volumes:
      - ./ml-services:/app
      - ml_models:/models
    depends_on:
      - mlflow
      - redis
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Monitoring & Observability
  # ==========================================

  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: nivesh-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--web.console.libraries=/usr/share/prometheus/console_libraries"
      - "--web.console.templates=/usr/share/prometheus/consoles"
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    networks:
      - nivesh-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

  grafana:
    image: grafana/grafana:10.2.3
    container_name: nivesh-grafana
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: false
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
    depends_on:
      - prometheus
    networks:
      - nivesh-network
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ==========================================
  # Backend Service (NestJS)
  # ==========================================

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: nivesh-backend
    environment:
      NODE_ENV: development
      PORT: 3000

      # Database URLs
      DATABASE_URL: postgresql://nivesh_user:nivesh_password@postgres:5432/nivesh_db
      NEO4J_URI: bolt://neo4j:7687
      NEO4J_USER: neo4j
      NEO4J_PASSWORD: nivesh_password
      MONGODB_URI: mongodb://nivesh_user:nivesh_password@mongodb:27017
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: nivesh_password
      CLICKHOUSE_HOST: http://clickhouse:8123
      CLICKHOUSE_USER: nivesh_user
      CLICKHOUSE_PASSWORD: nivesh_password

      # Kafka
      KAFKA_BROKERS: kafka:9092
      KAFKA_CLIENT_ID: nivesh-backend

      # Vector DB
      QDRANT_URL: http://qdrant:6333

      # MLOps
      MLFLOW_TRACKING_URI: http://mlflow:5000
      ML_API_URL: http://ml-api:8000

      # AI Services
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      GEMINI_MODEL: gemini-1.5-pro

      # Firebase
      FIREBASE_PROJECT_ID: ${FIREBASE_PROJECT_ID}
      FIREBASE_CLIENT_EMAIL: ${FIREBASE_CLIENT_EMAIL}
      FIREBASE_PRIVATE_KEY: ${FIREBASE_PRIVATE_KEY}
    ports:
      - "3000:3000"
    volumes:
      - ./backend:/app
      - /app/node_modules
    depends_on:
      - postgres
      - neo4j
      - mongodb
      - redis
      - clickhouse
      - kafka
      - qdrant
      - ml-api
    networks:
      - nivesh-network
    command: npm run dev

# ==========================================
# Volumes
# ==========================================
volumes:
  postgres_data:
  neo4j_data:
  neo4j_logs:
  mongodb_data:
  redis_data:
  clickhouse_data:
  zookeeper_data:
  zookeeper_logs:
  kafka_data:
  qdrant_data:
  mlflow_data:
  ml_models:
  prometheus_data:
  grafana_data:

# ==========================================
# Networks
# ==========================================
networks:
  nivesh-network:
    driver: bridge
